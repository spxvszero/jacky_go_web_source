let uploadUrl=location.origin+"/upload/interface",config_uploadMaxSizeUrl="/info/size",uploadMaxSizeUrl=location.origin+config_uploadMaxSizeUrl;var dropZone=document.getElementById("drop-zone");if("draggable"in dropZone&&"ondragenter"in dropZone&&"ondragleave"in dropZone&&"ondragover"in dropZone&&window.File&&window.FileList&&window.FileReader){function handleFileDragEnter(e){jkconsole("file in ",e),e.stopPropagation(),e.preventDefault(),this.classList.add("hovering"),$(".interactive_btn_class").css("z-index","0")}function handleFileDragLeave(e){jkconsole("file out ",e),e.stopPropagation(),e.preventDefault(),this.classList.remove("hovering"),$(".interactive_btn_class").css("z-index","5")}function handleFileDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function handleFileDrop(e){e.stopPropagation(),e.preventDefault(),this.classList.remove("hovering"),$(".interactive_btn_class").css("z-index","5"),jkconsole("drag finish -- ",e,e.target.files,e.dataTransfer.files,e.dataTransfer.items);var supportedDir=!0;try{e.dataTransfer.items[0].webkitGetAsEntry()}catch(e){jkconsole("不支持读取文件夹"),supportedDir=!1}supportedDir?(addFilesFromDragEvt(e.dataTransfer.items),jkconsole("dididididid --- ",e.dataTransfer.items," files --- ",e.dataTransfer.files)):addFiles(e.dataTransfer.files)}dropZone.addEventListener("dragenter",handleFileDragEnter,!1),dropZone.addEventListener("dragleave",handleFileDragLeave,!1),dropZone.addEventListener("dragover",handleFileDragOver,!1),dropZone.addEventListener("drop",handleFileDrop,!1)}async function getAllFileEntries(dataTransferItemList){let fileEntries=[],queue=[];for(let i=0;i<dataTransferItemList.length;i++)queue.push(dataTransferItemList[i].webkitGetAsEntry());for(;queue.length>0;){let entry=queue.shift();entry.isFile?fileEntries.push(entry):entry.isDirectory&&queue.push(...await readAllDirectoryEntries(entry.createReader()))}return fileEntries}async function readAllDirectoryEntries(directoryReader){let entries=[],readEntries=await readEntriesPromise(directoryReader);for(;readEntries.length>0;)entries.push(...readEntries),readEntries=await readEntriesPromise(directoryReader);return entries}async function readEntriesPromise(directoryReader){try{return await new Promise((resolve,reject)=>{directoryReader.readEntries(resolve,reject)})}catch(err){jkconsole(err)}}var tasksObj=new Object,groupObj=new Object,progressName="upload-progress-",percentageName="upload-percentage-",timeName="upload-time-",listItemName="list-item-",cancelBtnName="cancel-btn-";let taskId=0;function startUploadAll(){Object.keys(tasksObj).forEach((function(key){jkconsole("start upload ",key);var task=tasksObj[key];(task&&null==task.xhr||200!=task.xhr.status&&4==task.xhr.readyState)&&sendUploadRequest(task)}))}function openFile(){$("#open-file").click()}function addFiles(files){for(jkconsole("files - ",files),i=0;i<files.length;i++)addTask(files[i])}function addFilesFromDragEvt(dataTransferItems){getAllFileEntries(dataTransferItems).then(v=>{var time=v.length;v.map((item,k)=>{var fileEntry=item,p=fileEntry.fullPath,isFile=fileEntry.isFile;fileEntry.file(f=>{buildTaskWithGroup(f,p),0==--time&&jkconsole("finish map -- ",groupObj)})})}).finally(()=>{jkconsole("groupObject ",groupObj)})}function literateGroup(fileTaskId,groupPath,isAdd){var pathArr=groupPath.split("/");if(pathArr.pop(),pathArr.length<=1)return!1;for(var groupContent=groupObj,remove=!1,i=0;i<pathArr.length;i++){var name=pathArr[i];if(!(name.length<=0)){var obj=groupContent[name];if(isAdd)obj||((obj=new Object).allTasks=new Array,groupContent[name]=obj),obj.allTasks.push(fileTaskId);else for(var j=0;j<obj.allTasks.length;j++)if(obj.allTasks[j]==fileTaskId){if(obj.allTasks.splice(j,1),remove=!0,obj.allTasks.length<=0)break;j--}groupContent=obj}}return isAdd?pathArr[1]:remove}function buildTaskWithGroup(file,groupPath){taskId++;var fileName=file.name;tasksObj[taskId]={taskId:taskId,groupPath:groupPath,fileName:fileName,xhr:null,fileObject:file};var res=literateGroup(taskId,groupPath,!0);return res?addGroupListItem(res):addListItem(fileName,taskId),autoUpload(tasksObj[taskId]),taskId}function buildTask(file){taskId++;var fileName=file.name;return tasksObj[taskId]={taskId:taskId,fileName:fileName,xhr:null,fileObject:file},addListItem(fileName,taskId),autoUpload(tasksObj[taskId]),taskId}function addTask(file){jkconsole("add task - ",file);var reader=new FileReader;reader.onload=function(e){buildTask(file)},reader.onerror=function(e){jkconsole("read file error : ",e)},reader.readAsText(file)}function removeTask(taskId){var task=tasksObj[taskId];if(task){if(removeListItem(taskId),task.groupPath){var name=getGroupName(task.groupPath,0),remove;if(literateGroup(taskId,task.groupPath,!1))if(!groupObj[name].allTasks||groupObj[name].allTasks.length<=0)removeGroupListItem(name),delete groupObj[name];else{let spanId="title-"+name;var groupDiv;document.getElementById(spanId).innerText=name+"("+groupObj[name].allTasks.length+")",updataGroupProgress(name)}}delete tasksObj[taskId]}}function addGroupListItem(groupName){var listgroup=document.getElementById("list-group"),groupItem;if(document.getElementById("group-"+groupName)){let spanId="title-"+groupName;var groupDiv;document.getElementById(spanId).innerText=groupName+"("+groupObj[groupName].allTasks.length+")"}else{var item='<div id="group-'+groupName+'" class="container list-group-item">\n            <div class="row justify-content-between align-items-center">\n                <div class="interactive_btn_class col-10">\n<button type=\'button\' class=\'btn\' onclick="spreadGroup(\''+groupName+'\')"><svg id="icon-'+groupName+'" width="15px" height="15px" viewBox="0 0 15 15">\n    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n        <polygon id="Path" fill="#000000" points="0 0 0 15 15 7.5"></polygon>\n    </g>\n</svg>                    <span id="title-'+groupName+"\" class='align-middle'>"+groupName+'</span>\n </button><div id="inner-'+groupName+'"></div>                     <div id="'+progressName+"group-"+groupName+'" class="progress">\n                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>\n                    </div>\n                    <span  id="'+percentageName+"percent-"+groupName+'">0%</span><span></span>\n                </div>\n                <div class="interactive_btn_class col-2 text-center">\n                    <button  class="btn btn-primary" type="button" onclick="cancelGroupUploadFile(\''+groupName+"')\">cancel</button>\n                </div>\n            </div>\n        </div>";listgroup.insertAdjacentHTML("afterbegin",item)}}function removeGroupListItem(gName){var groupDiv;document.getElementById("group-"+gName).remove()}function addListItem(fileName,taskId){var listgroup=document.getElementById("list-group"),item='<div id="'+listItemName+taskId+'" class="container list-group-item">\n            <div class="row justify-content-between align-items-center">\n                <div class="col-10">\n                    <span>'+fileName+'</span>\n                    <div id="'+progressName+taskId+'" class="progress">\n                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>\n                    </div>\n                    <span id="'+percentageName+taskId+'">0%</span><span id="'+timeName+taskId+'"></span>\n                </div>\n                <div class="interactive_btn_class col-2 text-center">\n                    <button id="'+cancelBtnName+taskId+'"  class="btn btn-primary" type="button" onclick="cancelUploadFile('+taskId+')">cancel</button>\n                </div>\n            </div>\n        </div>';listgroup.insertAdjacentHTML("afterbegin",item)}function removeListItem(taskId){$("#"+listItemName+taskId).remove()}function spreadGroup(gName){var groupIconDiv=document.getElementById("icon-"+gName);groupIconDiv.classList.contains("more_btn_anim")?(groupIconDiv.classList.remove("more_btn_anim"),clearGroupInnerListItem(gName)):(groupIconDiv.classList.add("more_btn_anim"),addGroupInnerListItem(gName))}function addGroupInnerListItem(gName){var listgroup=document.getElementById("inner-"+gName);if(listgroup)for(var tasks=groupObj[gName].allTasks,i=0;i<tasks.length;i++){var taskId=tasks[i],task=tasksObj[taskId],percent="0%",actionBtnName="cancel",styleclass="";task.xhr&&200==task.xhr.status&&(percent="100%",actionBtnName="success",styleclass="success_btn");var item='<div id="'+listItemName+taskId+'" class="container" style=\'width: 80%\'>\n            <div class="row justify-content-between align-items-center">\n                <div class="col-10">\n                    <span>'+task.fileName+"</span>\n                    <span style='font-style: italic;color: lightgray;' id=\""+percentageName+taskId+'">'+percent+"</span>\n                    <span style='font-size: 10px;color: lightgray;'>"+task.groupPath+'</span>\n                </div>\n                <div class="col-2 interactive_btn_class text-center">\n                    <button id="'+cancelBtnName+taskId+'"  class="btn btn-link '+styleclass+'" type="button" onclick="cancelUploadFile('+taskId+')">'+actionBtnName+"</button>\n                </div>\n            </div>\n        </div>";listgroup.insertAdjacentHTML("afterbegin",item)}}function updataGroupProgress(gName){var groupProgressBar=progressName+"group-"+gName,percentageId=percentageName+"percent-"+gName,progressBar=document.getElementById(groupProgressBar),percentSpan=document.getElementById(percentageId),allTasks=groupObj[gName].allTasks;if(allTasks&&!(allTasks.length<=0)){for(var completeNum=0,i=0;i<allTasks.length;i++){var taskId=allTasks[i];tasksObj[taskId].xhr&&200==tasksObj[taskId].xhr.status&&completeNum++}var percentValue=completeNum/allTasks.length*100+"%";progressBar&&$(progressBar).children().css("width",percentValue),percentSpan&&(percentSpan.innerText=percentValue)}}function clearGroupInnerListItem(gName){var listgroup=document.getElementById("inner-"+gName);listgroup&&(listgroup.innerText="")}function getGroupName(gName,number){if(null!=gName){var pathArr=gName.split("/");return pathArr.pop(),number+1>=pathArr.length?null:pathArr[number+1]}}function autoUpload(task){$("#auto-upload-checkbox")[0].checked&&sendUploadRequest(task)}function clearAll(){Object.keys(tasksObj).forEach((function(key){jkconsole("start upload ",key);var task=tasksObj[key];task&&(task.xhr?(4==task.xhr.readyState||task.xhr.abort(),removeTask(key)):removeTask(key))}))}function clearUpTask(){Object.keys(tasksObj).forEach((function(key){jkconsole("clear up task",key);var task=tasksObj[key];task&&task.xhr&&4==task.xhr.readyState&&removeTask(key)}))}function retryTask(task){delete task.xhr;var btnDiv=document.getElementById(cancelBtnName+task.taskId);$(btnDiv)[0].innerText="cancel",$(btnDiv)[0].classList.contains("btn-primary")?$(btnDiv)[0].classList.remove("btn-secondary"):$(btnDiv)[0].classList.remove("failed_btn");var progressBar=document.getElementById(progressName+task.taskId);progressBar&&$(progressBar).children().removeClass("bg-secondary"),sendUploadRequest(task)}function sendUploadRequest(task){let url=uploadUrl;var xhr;let form=new FormData;form.append("file",task.fileObject),task.groupPath&&form.append("relativePath",task.groupPath),(xhr=new XMLHttpRequest).open("post",url,!0),xhr.addEventListener("load",(function(e){uploadComplete(e,task.taskId)}),!1),xhr.addEventListener("error",(function(e){uploadFailed(e,task.taskId)})),xhr.upload.addEventListener("progress",(function(e){progressFunction(e,task.taskId)})),xhr.upload.onloadstart=function(){task.beginTime=(new Date).getTime(),task.ot=(new Date).getTime(),task.oloaded=0,task.maxspeed=0,task.maxspeedStr="b/s"},xhr.upload.onreadystatechange=function(){4==xhr.readyState&&(200==xhr.status?(jkconsole("upload complete"),jkconsole("response: "+xhr.responseText)):showFailed(xhr.responseText))},task.xhr=xhr,xhr.send(form)}function uploadComplete(evt,taskId){jkconsole("上传---结果 ",evt,taskId,tasksObj[taskId]);var btnName=cancelBtnName+taskId,btnDiv=document.getElementById(btnName);if(200==evt.target.status){btnDiv&&($(btnDiv)[0].innerText="success",$(btnDiv)[0].classList.contains("btn-primary")?$(btnDiv)[0].classList.add("btn-success"):$(btnDiv)[0].classList.add("success_btn"));var progressBar=document.getElementById(progressName+taskId);progressBar&&$(progressBar).children().addClass("bg-success");var task=tasksObj[taskId],time=document.getElementById(timeName+taskId);if(time){var nt,pertime=((new Date).getTime()-task.beginTime)/1e3,speed=pertime<=0?task.fileObject.size:task.fileObject.size/pertime,bspeed=speed,units="b/s";speed/1024>1&&(speed/=1024,units="k/s"),speed/1024>1&&(speed/=1024,units="M/s"),speed=speed.toFixed(1),time.innerHTML="，平均速度："+speed+units+"，最大速度："+task.maxspeedStr+"，所花时间："+pertime+"s"}var gName=getGroupName(task.groupPath,0);gName&&updataGroupProgress(gName),checkUploadSize()}else uploadFailed(evt,taskId)}function uploadFailed(evt,taskId){var btnDiv=document.getElementById(cancelBtnName+taskId);$(btnDiv)[0].innerText="retry",$(btnDiv)[0].classList.contains("btn-primary")?$(btnDiv)[0].classList.add("btn-secondary"):$(btnDiv)[0].classList.add("failed_btn");var progressBar=document.getElementById(progressName+taskId);progressBar&&$(progressBar).children().addClass("bg-secondary"),showFailed(evt.target.responseText)}function cancelGroupUploadFile(gName){for(var tasks,taskIds=groupObj[gName].allTasks.slice(),i=0;i<taskIds.length;i++)cancelUploadFile(taskIds[i])}function cancelUploadFile(taskId){jkconsole("cancel click -- ",taskId);var task=tasksObj[taskId];task&&(task.xhr?200==task.xhr.status?removeTask(taskId):4==task.xhr.readyState?retryTask(task):(task.xhr.abort(),jkconsole("cancel ",taskId," success"),removeTask(taskId)):removeTask(taskId))}function progressFunction(evt,taskId){var progressBar=document.getElementById(progressName+taskId),percentageDiv=document.getElementById(percentageName+taskId),task=tasksObj[taskId];if(evt.lengthComputable){var percentValue=Math.round(evt.loaded/evt.total*100)+"%";progressBar&&$(progressBar).children().css("width",percentValue),percentageDiv&&(percentageDiv.innerHTML=percentValue)}var time=document.getElementById(timeName+taskId),nt,pertime=((new Date).getTime()-task.ot)/1e3;task.ot=(new Date).getTime();var perload=evt.loaded-task.oloaded;task.oloaded=evt.loaded;var speed=pertime<=0?perload:perload/pertime,bspeed=speed,units="b/s";speed/1024>1&&(speed/=1024,units="k/s"),speed/1024>1&&(speed/=1024,units="M/s"),speed=speed.toFixed(1),bspeed>task.maxspeed&&(task.maxspeed=bspeed,task.maxspeedStr=speed+units);var resttime=((evt.total-evt.loaded)/bspeed).toFixed(1);time&&(time.innerHTML="，速度："+speed+units+"，剩余时间："+resttime+"s",0==bspeed&&(time.innerHTML="，速度：-"+units+"，剩余时间：-s"))}function formatBytes(origin){var result=origin,unit="B";return result/1024>1&&(result/=1024,unit="kB"),result/1024>1&&(result/=1024,unit="MB"),result/1024>1&&(result/=1024,unit="GB"),result.toFixed(2)+" "+unit}function hsl_col_perc(percent,start,end){var a,b,c;return"hsl("+((end-start)*(percent/100)+start)+", 80%, 50%)"}function updateDirSize(){var xhttp;(xhttp=new XMLHttpRequest).onreadystatechange=function(){if(4==this.readyState)if(200==this.status){jsonObj=JSON.parse(this.responseText);var ele=document.getElementById("dir-size-value");ele.innerText=formatBytes(jsonObj.used)+" / "+formatBytes(jsonObj.max),jsonObj.used>=jsonObj.max&&(ele.innerText=ele.innerText+"(FULL)"),ele.style.color=hsl_col_perc(100*Math.min(jsonObj.used/jsonObj.max,1),120,360)}else showFailed(this.responseText)},xhttp.open("GET",uploadMaxSizeUrl,!0),xhttp.send()}function checkUploadSize(){config_uploadMaxSizeUrl&&config_uploadMaxSizeUrl.length>0?updateDirSize():document.getElementById("dir-size").style.display="none"}checkUploadSize();const showToastAnime="\n        .dialog{\n            position: fixed;\n            z-index: 9998;\n            width: 100%;\n            height: 100%;\n            top: 0;\n            left: 0;\n            background-color: #0000;\n            text-align: center;\n            pointer-events: none;\n            transition: opacity 0.3s;\n            opacity: 0;\n        }\n        .dialog.show{\n            opacity:1;\n        }\n    ",style=document.createElement("style");function showMsg(style,msg,dismissTime){var dialog=document.createElement("div");dialog.innerHTML='<div class="dialog"><btn style="position: relative;top: 80%;padding: 10px;border-radius: 5px;width: 50%;pointer-events: none;max-width: 300px;" class="'+style+'">'+msg+"</btn></div>",document.body.appendChild(dialog),setTimeout((function(){dialog.children[0].classList.add("show")}),50),setTimeout((function(){dialog.children[0].classList.remove("show")}),dismissTime-300),setTimeout((function(){document.body.removeChild(dialog)}),dismissTime)}function showFailed(msg){showMsg("btn-danger",msg,3e3)}function jkconsole(...args){}style.type="text/css",style.innerHTML=showToastAnime,document.getElementsByTagName("head")[0].appendChild(style);